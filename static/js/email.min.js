// EmailJS JavaScript SDK v4.4.1
// 用于在客户端发送电子邮件的JavaScript库
// 官方文档: https://www.emailjs.com/docs/

var emailjs = (function (exports) {
  "use strict";
  
  /**
   * 响应状态类
   * 用于表示API请求的响应状态和文本
   */
  class EmailJSResponseStatus {
    constructor(status = 0, text = "Network Error") {
      this.status = status;    // HTTP状态码
      this.text = text;        // 响应文本
    }
  }
  
  /**
   * 配置对象
   * 存储API端点、密钥和其他全局设置
   */
  const defaults = {
    origin: "https://api.emailjs.com", // API基础URL
    blockHeadless: false,              // 是否阻止无头浏览器
    storageProvider: (() => {
      // 使用localStorage作为存储提供者
      if (typeof localStorage !== "undefined") {
        return {
          get: (key) => Promise.resolve(localStorage.getItem(key)),
          set: (key, value) => Promise.resolve(localStorage.setItem(key, value)),
          remove: (key) => Promise.resolve(localStorage.removeItem(key))
        };
      }
    })()
  };
  
  /**
   * 解析配置参数
   * @param {string|Object} config - 配置对象或公钥
   * @returns {Object} 解析后的配置对象
   */
  const parseConfig = (config) => {
    if (!config) return {};
    if (typeof config === "string") return { publicKey: config };
    if (Object.prototype.toString.call(config) === "[object Object]") return config;
    return {};
  };
  
  /**
   * 初始化EmailJS SDK
   * @param {string|Object} config - 公钥或配置对象
   * @param {string} origin - API基础URL（可选）
   */
  const init = function (config, origin = "https://api.emailjs.com") {
    if (!config) return;
    const parsedConfig = parseConfig(config);
    defaults.publicKey = parsedConfig.publicKey;
    defaults.blockHeadless = parsedConfig.blockHeadless;
    defaults.storageProvider = parsedConfig.storageProvider;
    defaults.blockList = parsedConfig.blockList;
    defaults.limitRate = parsedConfig.limitRate;
    defaults.origin = parsedConfig.origin || origin;
  };
  
  /**
   * 发送API请求
   * @param {string} path - API路径
   * @param {string|FormData} body - 请求体
   * @param {Object} headers - 请求头（可选）
   * @returns {Promise<EmailJSResponseStatus>} 响应状态
   */
  const sendRequest = async function (path, body, headers = {}) {
    const response = await fetch(defaults.origin + path, {
      method: "POST",
      headers: headers,
      body: body
    });
    const responseText = await response.text();
    const status = new EmailJSResponseStatus(response.status, responseText);
    
    if (response.ok) {
      return status;
    }
    throw status;
  };
  
  /**
   * 验证必要的参数
   * @param {string} publicKey - EmailJS公钥
   * @param {string} serviceId - 服务ID
   * @param {string} templateId - 模板ID
   */
  const validateParams = (publicKey, serviceId, templateId) => {
    if (!publicKey || typeof publicKey !== "string") {
      throw "The public key is required. Visit https://dashboard.emailjs.com/admin/account";
    }
    if (!serviceId || typeof serviceId !== "string") {
      throw "The service ID is required. Visit https://dashboard.emailjs.com/admin";
    }
    if (!templateId || typeof templateId !== "string") {
      throw "The template ID is required. Visit https://dashboard.emailjs.com/admin/templates";
    }
  };
  
  /**
   * 检测是否为无头浏览器
   * @param {Object} navigator - navigator对象
   * @returns {boolean} 是否为无头浏览器
   */
  const isHeadlessBrowser = (navigator) => {
    return navigator.webdriver || !navigator.languages || navigator.languages.length === 0;
  };
  
  /**
   * 创建无头浏览器错误
   * @returns {EmailJSResponseStatus} 错误响应
   */
  const createHeadlessError = () => {
    return new EmailJSResponseStatus(451, "Unavailable For Headless Browser");
  };
  
  /**
   * 检查是否在阻止列表中
   * @param {Object} blockList - 阻止列表配置
   * @param {Object|FormData} params - 请求参数
   * @returns {boolean} 是否被阻止
   */
  const isBlocked = (blockList, params) => {
    if (!blockList.list?.length || !blockList.watchVariable) return false;
    
    // 验证阻止列表配置
    if (!Array.isArray(blockList.list)) {
      throw "The BlockList list has to be an array";
    }
    if (typeof blockList.watchVariable !== "string") {
      throw "The BlockList watchVariable has to be a string";
    }
    
    // 获取监控变量的值
    let value;
    if (params instanceof FormData) {
      value = params.get(blockList.watchVariable);
    } else {
      value = params[blockList.watchVariable];
    }
    
    return typeof value === "string" && blockList.list.includes(value);
  };
  
  /**
   * 创建禁止访问错误
   * @returns {EmailJSResponseStatus} 错误响应
   */
  const createForbiddenError = () => {
    return new EmailJSResponseStatus(403, "Forbidden");
  };
  
  /**
   * 检查请求频率限制
   * @param {string} path - 当前路径
   * @param {Object} limitRate - 频率限制配置
   * @param {Object} storageProvider - 存储提供者
   * @returns {Promise<boolean>} 是否超过限制
   */
  const isRateLimited = async (path, limitRate, storageProvider) => {
    if (!limitRate.throttle || !storageProvider) return false;
    
    // 验证频率限制配置
    if (typeof limitRate.throttle !== "number" || limitRate.throttle < 0) {
      throw "The LimitRate throttle has to be a positive number";
    }
    if (limitRate.id && typeof limitRate.id !== "string") {
      throw "The LimitRate ID has to be a non-empty string";
    }
    
    // 使用路径作为默认ID
    const id = limitRate.id || path;
    
    // 检查上次请求时间
    const remainingTime = await (async (key, throttle, storage) => {
      const lastCallTime = Number(await storage.get(key) || 0);
      return throttle - Date.now() + lastCallTime;
    })(id, limitRate.throttle, storageProvider);
    
    // 如果还有剩余限制时间，返回true表示被限制
    if (remainingTime > 0) {
      return true;
    }
    
    // 否则更新最后请求时间并返回false
    await storageProvider.set(id, Date.now().toString());
    return false;
  };
  
  /**
   * 创建请求过多错误
   * @returns {EmailJSResponseStatus} 错误响应
   */
  const createTooManyRequestsError = () => {
    return new EmailJSResponseStatus(429, "Too Many Requests");
  };
  
  /**
   * 发送电子邮件
   * @param {string} serviceId - 服务ID
   * @param {string} templateId - 模板ID
   * @param {Object} templateParams - 模板参数
   * @param {string|Object} config - 配置（可选）
   * @returns {Promise<EmailJSResponseStatus>} 响应状态
   */
  const send = async function (serviceId, templateId, templateParams, config) {
    // 解析配置
    const parsedConfig = parseConfig(config);
    const publicKey = parsedConfig.publicKey || defaults.publicKey;
    const blockHeadless = parsedConfig.blockHeadless || defaults.blockHeadless;
    const storageProvider = parsedConfig.storageProvider || defaults.storageProvider;
    const blockList = { ...defaults.blockList, ...parsedConfig.blockList };
    const limitRate = { ...defaults.limitRate, ...parsedConfig.limitRate };
    
    // 检查是否为无头浏览器
    if (blockHeadless && isHeadlessBrowser(navigator)) {
      return Promise.reject(createHeadlessError());
    }
    
    // 验证参数
    validateParams(publicKey, serviceId, templateId);
    
    // 验证模板参数
    if (templateParams && Object.prototype.toString.call(templateParams) !== "[object Object]") {
      throw "The template params have to be the object. Visit https://www.emailjs.com/docs/sdk/send/";
    }
    
    // 检查是否在阻止列表中
    if (templateParams && isBlocked(blockList, templateParams)) {
      return Promise.reject(createForbiddenError());
    }
    
    // 检查频率限制
    if (await isRateLimited(location.pathname, limitRate, storageProvider)) {
      return Promise.reject(createTooManyRequestsError());
    }
    
    // 准备请求数据
    const data = {
      lib_version: "4.4.1",
      user_id: publicKey,
      service_id: serviceId,
      template_id: templateId,
      template_params: templateParams
    };
    
    // 发送请求
    return sendRequest("/api/v1.0/email/send", JSON.stringify(data), {
      "Content-type": "application/json"
    });
  };
  
  /**
   * 从表单发送电子邮件
   * @param {string} serviceId - 服务ID
   * @param {string} templateId - 模板ID
   * @param {string|HTMLFormElement} form - 表单选择器或表单元素
   * @param {string|Object} config - 配置（可选）
   * @returns {Promise<EmailJSResponseStatus>} 响应状态
   */
  const sendForm = async function (serviceId, templateId, form, config) {
    // 解析配置
    const parsedConfig = parseConfig(config);
    const publicKey = parsedConfig.publicKey || defaults.publicKey;
    const blockHeadless = parsedConfig.blockHeadless || defaults.blockHeadless;
    const storageProvider = defaults.storageProvider || parsedConfig.storageProvider;
    const blockList = { ...defaults.blockList, ...parsedConfig.blockList };
    const limitRate = { ...defaults.limitRate, ...parsedConfig.limitRate };
    
    // 检查是否为无头浏览器
    if (blockHeadless && isHeadlessBrowser(navigator)) {
      return Promise.reject(createHeadlessError());
    }
    
    // 获取表单元素
    const formElement = typeof form === "string" ? document.querySelector(form) : form;
    
    // 验证参数
    validateParams(publicKey, serviceId, templateId);
    
    // 验证表单元素
    if (!formElement || formElement.nodeName !== "FORM") {
      throw "The 3rd parameter is expected to be the HTML form element or the style selector of the form";
    }
    
    // 创建表单数据
    const formData = new FormData(formElement);
    
    // 检查是否在阻止列表中
    if (isBlocked(blockList, formData)) {
      return Promise.reject(createForbiddenError());
    }
    
    // 检查频率限制
    if (await isRateLimited(location.pathname, limitRate, storageProvider)) {
      return Promise.reject(createTooManyRequestsError());
    }
    
    // 添加必要的参数
    formData.append("lib_version", "4.4.1");
    formData.append("service_id", serviceId);
    formData.append("template_id", templateId);
    formData.append("user_id", publicKey);
    
    // 发送请求
    return sendRequest("/api/v1.0/email/send-form", formData);
  };
  
  // 导出SDK对象
  exports.EmailJSResponseStatus = EmailJSResponseStatus;
  exports.default = {
    init: init,
    send: send,
    sendForm: sendForm,
    EmailJSResponseStatus: EmailJSResponseStatus
  };
  exports.init = init;
  exports.send = send;
  exports.sendForm = sendForm;
  
  // 标记为ES模块
  Object.defineProperty(exports, "__esModule", {
    value: true
  });
  
  return exports;
})({});